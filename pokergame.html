<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Texas Hold'em ‚Äì Online</title>
  <style>
    :root{
      --bg:#0b3d2e;--text:#eaf7f2;--muted:#bfe6d9;--acc:#ffcf5a;
      --line:rgba(255,255,255,.14);--danger:#ff4d4d;--ok:#6bffb1;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,Arial;
      background:radial-gradient(1200px 800px at 50% 15%, #14624a, var(--bg));
      color:var(--text);

      /* ‚úÖ a teljes oldal NE scrollozzon -> csak a bels≈ë panelek */
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    header{
      padding:10px 12px;
      display:flex; gap:10px;
      justify-content:space-between;
      align-items:center;
      background:rgba(0,0,0,.18);
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
      flex:0 0 auto;
    }

    .badge{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted)}
    .badge.bigMoney{font-size:16px;font-weight:900;color:var(--acc)}
    .big{font-size:16px;font-weight:900;color:var(--acc)}

    select,button,input{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px;
      border-radius:12px;
      outline:none;
      box-sizing:border-box;
    }
    button{cursor:pointer;font-weight:900}
    button:disabled{opacity:.5;cursor:not-allowed}
    button.readyOn{background:rgba(31,122,74,.45);border-color:rgba(107,255,177,.55);color:#eafff4}

    /* ‚úÖ a header alatti r√©sz t√∂ltse ki a marad√©k helyet */
    .app{
      flex:1;
      min-height:0;        /* ‚úÖ kulcs: a bels≈ë scrollokhoz kell */
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
    }

    .topbar{
      display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      flex:0 0 auto;
    }
    .tabs{display:flex;gap:8px}
    .tab{min-width:120px;display:flex;align-items:center;justify-content:center;gap:8px}
    .tab.active{border-color:rgba(255,207,90,.6);box-shadow:0 0 0 6px rgba(255,207,90,.08)}
    .hidden{display:none}

    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      padding:12px;
      position:relative;
      min-height:0;        /* ‚úÖ kulcs */
    }

    .gameView{
      flex:1;
      min-height:0;        /* ‚úÖ kulcs */
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    /* ===== TABLE + HUD ===== */
    .tableWrap{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:10px;
      align-items:stretch;
      justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(255,255,255,.06);
      padding:10px;
      overflow:hidden;
    }

    .table{
      position:relative;
      width:100%;
      height:100%;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.25), transparent 45%),
        repeating-linear-gradient(45deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 6px, transparent 6px, transparent 12px),
        radial-gradient(ellipse at center, #0f5a3f, #083b2a);
      box-shadow: inset 0 0 60px rgba(0,0,0,.55), 0 20px 60px rgba(0,0,0,.45);
    }
    .table::before{content:"";position:absolute; inset:18px;border-radius:999px;border:1px dashed rgba(255,255,255,.14)}

    .boardCenter{
      position:absolute;left:50%; top:50%;transform:translate(-50%,-50%);
      width:min(740px, 94%);
      padding:10px 8px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);text-align:center
    }
    .boardRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;min-height:72px}
    .myHandRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}

    .card{width:46px;height:64px;background:#f7f7f7;color:#1b1b1b;border-radius:10px;display:flex;flex-direction:column;justify-content:space-between;padding:6px;border:1px solid rgba(0,0,0,.12)}
    .card.red{color:#c21d1d}

    .seat{
      position:absolute;width:160px;padding:8px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);
      transform:translate(-50%,-50%);font-size:11px;line-height:1.2;
    }
    .seat .topline{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .seat .name{font-weight:900;color:var(--text);max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .seat .meta{color:var(--muted);white-space:nowrap}
    .seat .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .seat .small{margin-top:6px;color:var(--muted)}
    .seat.folded{opacity:.55}
    .seat.me{border-color:rgba(107,255,177,.35)}
    .seat .handMini{display:flex;gap:6px;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .seat .handMini .card{transform:scale(.72);transform-origin:center}

    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .pill.sb{border-color:rgba(255,207,90,.45);color:var(--acc)}
    .pill.bb{border-color:rgba(255,207,90,.85);color:var(--acc)}
    .pill.d{border-color:rgba(255,207,90,.25);color:var(--acc)}
    .pill.ready{border-color:rgba(107,255,177,.4);color:var(--ok)}
    .pill.notready{border-color:rgba(255,107,107,.4);color:var(--danger)}

    /* er≈ës villog√°s, ha valaki soron van */
    @keyframes blinkRed {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,77,77,.0); }
      50% { box-shadow: 0 0 0 14px rgba(255,77,77,.22); }
    }
    .seat.toActBlink{
      outline: 5px solid rgba(255,77,77,1);
      animation: blinkRed 0.85s infinite;
      box-shadow:
        0 0 0 6px rgba(255,77,77,.25),
        0 0 25px rgba(255,77,77,.65),
        inset 0 0 18px rgba(255,77,77,.25);
    }
    .turnDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--danger);box-shadow:0 0 10px rgba(255,77,77,.6);animation:blinkRed 0.85s infinite;margin-right:8px;}

    /* ===== ACTION HUD ===== */
    .actionPanel{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:12px;
      border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      min-width:0;
    }
    .actionPanel button, .actionPanel input{width:100%}
    .turnBox{
      padding:8px 10px;border-radius:14px;border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.08);display:flex;align-items:center;font-weight:900;color:#ffd5d5;
    }
    .turnBox.hidden{display:none}

    .winnerBanner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:2px solid rgba(255,207,90,.55);
      background:rgba(0,0,0,.42);
      font-weight:1000;
      font-size:22px;
      letter-spacing:.3px;
      color:#ffe6a6;
      text-shadow:0 2px 14px rgba(0,0,0,.55);
    }
    .winnerBanner.hidden{display:none}

    /* CHAT VIEW */
    .chatGrid{
      flex:1;
      min-height:0; /* ‚úÖ kulcs */
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:10px;
    }
    .scrollBox{
      min-height:0; /* ‚úÖ kulcs */
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.06)
    }

    .playersList .pitem{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12);align-items:center}
    .playersList .pitem:last-child{border-bottom:none}

    /* ‚úÖ a chatbox legyen AZ a r√©sz, ami scrollozik */
    .chatbox{
      flex:1;
      min-height:0; /* ‚úÖ kulcs */
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,.18);
      white-space:pre-wrap;
    }
    .chatline{margin:0 0 8px 0;color:var(--muted)}
    .chatline b{color:var(--acc)}
    .mention{color:var(--acc);font-weight:900}
    .chatSend{display:flex;gap:8px;margin-top:10px;flex:0 0 auto}
    .chatSend input{flex:1}
    #chatNotif{background:#ff4d4d;color:white;font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid rgba(0,0,0,.18)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}

    @media (max-width: 980px){
      /* mobilon engedj√ºk a body scrollt, mert kev√©s a hely */
      body{overflow:auto}
      .app{min-height:auto}
      .chatGrid{grid-template-columns:1fr}
      .tableWrap{grid-template-columns:1fr}
      .tableWrap{height:520px}
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="gap:10px">
    <span class="badge">Szoba: <b id="room"></b></span>
    <span class="badge">Te: <b id="me"></b></span>
    <span class="badge">Kapcsolat: <b id="status">‚Äî</b></span>
    <span class="badge">Sz√©k: <b id="seat">‚Äî</b></span>
    <span class="badge">Host: <b id="host">‚Äî</b></span>
  </div>
  <div class="big" id="startInfo">V√°rakoz√°s (K√©sz / Ready)‚Ä¶</div>
</header>

<div class="app">
  <div class="topbar">
    <div class="row" style="gap:10px">
      <button id="readyBtn">K√âSZ / READY</button>
      <span class="badge">Utca: <b id="streetLbl">‚Äî</b></span>
      <span class="badge bigMoney">Aktu√°lis t√©t: <b id="currentBetLbl">0</b></span>
      <span class="badge bigMoney">üí∞ Pot: <b id="potLbl">0</b></span>
      <span class="badge">K√∂r: <b id="handNoLbl">0</b></span>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabGame">J√°t√©k</button>
      <button class="tab" id="tabChat">Chat <span id="chatNotif" class="pill hidden">‚óè</span></button>
      <button class="tab hidden" id="tabHost">Host</button>
    </div>
  </div>

  <!-- GAME -->
  <section class="panel gameView" id="viewGame">
    <div class="tableWrap">
      <div class="table" id="table">
        <div class="boardCenter">
          <div class="badge" style="display:inline-block;margin-bottom:8px">K√∂z√∂s lapok</div>
          <div class="boardRow" id="boardRow"></div>

          <div class="badge" style="display:inline-block;margin:10px 0 6px 0">Saj√°t lapjaid</div>
          <div class="myHandRow" id="myHandRow"></div>

          <div class="hint" id="turnHint" style="margin-top:8px;font-size:13px">‚Äî</div>
          <div id="winnerBanner" class="winnerBanner hidden"></div>
        </div>
        <div id="seatLayer"></div>
      </div>

      <!-- ACTION HUD -->
      <div class="actionPanel">
        <div id="yourTurnBox" class="turnBox hidden"><span class="turnDot"></span>TE VAGY SORON!</div>
        <button id="actionCall">PASS</button>
        <button id="actionFold">DOB√ÅS</button>

        <!-- a szerver "raise to" m√≥don kezeli (c√©l t√©t szint) -->
        <input id="raiseAmt" type="number" value="40" min="0" step="10" />
        <button id="actionRaise">T√âT / EMEL√âS</button>

        <div class="hint" id="raiseHint" style="margin-top:2px">
          Emel√©s mez≈ë: a <b>c√©l t√©t szintet</b> √≠rd be (pl. 80-ig emel).
        </div>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section class="panel hidden" id="viewChat" style="flex:1;min-height:0;">
    <div class="chatGrid">
      <div class="scrollBox playersList" id="playersBox">
        <div class="badge">J√°t√©kosok</div>
        <div class="hint">N√©v ‚Ä¢ üí∞ egyenleg ‚Ä¢ K√âSZ</div>
        <div id="players" style="margin-top:10px"></div>
      </div>

      <div style="min-height:0;display:flex;flex-direction:column;gap:10px">
        <div class="badge">Chat</div>

        <!-- ‚úÖ ez scrollozik -->
        <div class="chatbox" id="chatBox"></div>

        <div class="chatSend">
          <input id="chatMsg" placeholder="√çrj valamit‚Ä¶ (@Bruno)" maxlength="300" />
          <button id="chatSend">K√ºld√©s</button>
        </div>
        <div class="hint">Taggel√©s: √≠rd be pl. <b>@Bruno</b> vagy <b>@Csongor</b></div>
      </div>
    </div>
  </section>

  <!-- HOST -->
  <section class="panel hidden" id="viewHost" style="flex:1;min-height:0;">
    <div>
      <div class="badge">Host be√°ll√≠t√°sok</div>
      <div class="hint">√öj j√°t√©k param√©terei + k√∂r v√©g√©n zseton ad√°s.</div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <label class="badge">Robotok:
          <select id="botCount">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option>
            <option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
            <option value="6">6</option><option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
          </select>
        </label>

        <label class="badge">Kezd≈ë zseton:
          <select id="stackSel">
            <option value="500">500</option><option value="1000" selected>1000</option><option value="2000">2000</option><option value="5000">5000</option>
          </select>
        </label>

        <label class="badge">Vakok (SB/BB):
          <select id="blindsSel">
            <option value="5,10">5/10</option>
            <option value="10,20" selected>10/20</option>
            <option value="25,50">25/50</option>
            <option value="50,100">50/100</option>
          </select>
        </label>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="startGameBtn">‚ñ∂ J√ÅT√âK IND√çT√ÅSA</button>
        <button id="newHandBtn">üîÑ √öJ K√ñR</button>
        <button id="newGameBtn">üîÅ √öJ J√ÅT√âK</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label class="badge">J√°t√©kos:
          <select id="topupPlayer"></select>
        </label>
        <label class="badge">√ñsszeg:
          <input id="topupAmt" type="number" value="500" min="1" step="50" style="width:120px" />
        </label>
        <button id="topupBtn">‚ûï Zseton ad√°sa</button>
      </div>
      <div class="hint">Zsetont adni <b>k√∂r v√©g√©n</b> lehet.</div>
    </div>
  </section>
</div>

<script>
  // ====== URL params + pw
  const qs = new URLSearchParams(location.search);
  const room = (qs.get("room")||"").trim();
  const name = (qs.get("name")||"").trim();
  const wsUrl = (qs.get("ws")||"").trim();
  const pw = sessionStorage.getItem("poker_room_pw") || "";

  if(!room || !name || !wsUrl || !pw){
    alert("Hi√°nyzik a szoba / n√©v / ws / jelsz√≥. Menj vissza a lobbyba!");
    location.href = "pokerlobby.html";
  }

  // ====== UI refs
  const ui = {
    room: document.getElementById("room"),
    me: document.getElementById("me"),
    status: document.getElementById("status"),
    seat: document.getElementById("seat"),
    host: document.getElementById("host"),
    startInfo: document.getElementById("startInfo"),

    streetLbl: document.getElementById("streetLbl"),
    currentBetLbl: document.getElementById("currentBetLbl"),
    potLbl: document.getElementById("potLbl"),
    handNoLbl: document.getElementById("handNoLbl"),

    tabGame: document.getElementById("tabGame"),
    tabChat: document.getElementById("tabChat"),
    tabHost: document.getElementById("tabHost"),
    chatNotif: document.getElementById("chatNotif"),

    viewGame: document.getElementById("viewGame"),
    viewChat: document.getElementById("viewChat"),
    viewHost: document.getElementById("viewHost"),

    readyBtn: document.getElementById("readyBtn"),

    boardRow: document.getElementById("boardRow"),
    myHandRow: document.getElementById("myHandRow"),
    seatLayer: document.getElementById("seatLayer"),
    tableEl: document.getElementById("table"),
    turnHint: document.getElementById("turnHint"),
    winnerBanner: document.getElementById("winnerBanner"),

    actionFold: document.getElementById("actionFold"),
    actionCall: document.getElementById("actionCall"),
    actionRaise: document.getElementById("actionRaise"),
    raiseAmt: document.getElementById("raiseAmt"),
    yourTurnBox: document.getElementById("yourTurnBox"),

    players: document.getElementById("players"),
    chatBox: document.getElementById("chatBox"),
    chatMsg: document.getElementById("chatMsg"),
    chatSend: document.getElementById("chatSend"),

    botCount: document.getElementById("botCount"),
    stackSel: document.getElementById("stackSel"),
    blindsSel: document.getElementById("blindsSel"),
    startGameBtn: document.getElementById("startGameBtn"),
    newHandBtn: document.getElementById("newHandBtn"),
    newGameBtn: document.getElementById("newGameBtn"),
    topupPlayer: document.getElementById("topupPlayer"),
    topupAmt: document.getElementById("topupAmt"),
    topupBtn: document.getElementById("topupBtn"),
  };

  ui.room.textContent = room;
  ui.me.textContent = name;

  function switchTab(which){
    ui.tabGame.classList.toggle("active", which==="game");
    ui.tabChat.classList.toggle("active", which==="chat");
    ui.tabHost.classList.toggle("active", which==="host");

    ui.viewGame.classList.toggle("hidden", which!=="game");
    ui.viewChat.classList.toggle("hidden", which!=="chat");
    ui.viewHost.classList.toggle("hidden", which!=="host");

    if(which==="chat") ui.chatNotif.classList.add("hidden");
  }
  ui.tabGame.onclick = ()=>switchTab("game");
  ui.tabChat.onclick = ()=>switchTab("chat");
  ui.tabHost.onclick = ()=>switchTab("host");
  switchTab("game");

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function highlightMentionsSafe(text){
    const safe = escapeHtml(text);
    return safe.replace(/@([^\s]+)/g, (m,p1)=>`<span class="mention">@${p1}</span>`);
  }

  function appendChat(n,t){
    const p=document.createElement("p");
    p.className="chatline";
    p.innerHTML = `<b>${escapeHtml(n)}:</b> ${highlightMentionsSafe(t)}`;
    ui.chatBox.appendChild(p);

    // ‚úÖ chatbox bels≈ë scroll a v√©g√©re
    ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

    // ha nem a chat tabon vagyunk, mutassunk jelz√©st
    if(ui.viewChat.classList.contains("hidden")) ui.chatNotif.classList.remove("hidden");
  }

  // ====== Cards render
  const SUITS=["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const RANKS=["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
  function isRedSuit(s){ return s==="‚ô•" || s==="‚ô¶"; }

  function renderCard(c){
    const d=document.createElement("div");
    d.className="card"+(isRedSuit(c.s)?" red":"");
    d.innerHTML = `<div style="font-weight:900;font-size:16px;line-height:1">${escapeHtml(c.r)}</div>
                   <div style="align-self:flex-end;font-size:16px;line-height:1">${escapeHtml(c.s)}</div>`;
    return d;
  }
  function faceDown(){
    const d=document.createElement("div");
    d.className="card";
    d.style.background="rgba(0,0,0,.18)";
    d.style.color="rgba(255,255,255,.65)";
    d.innerHTML="<div style='font-weight:900'>?</div><div style='align-self:flex-end'>üÇ†</div>";
    return d;
  }

  // ====== WS state
  let ws=null, clientId=null, hostId=null, mySeat=null;
  let lobby = { humans:[], ready:{}, cfg:{bots:3, stack:1000, blinds:"10,20"}, started:false };
  let state = null;

  function isHost(){ return clientId && hostId && clientId===hostId; }
  function send(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

  // ====== Actions / intents
  ui.chatSend.onclick = ()=>{
    const text = ui.chatMsg.value.trim().slice(0,300);
    if(!text) return;
    ui.chatMsg.value="";
    send({ type:"intent", intent:"chat", text });
  };

  // ‚úÖ Enter: k√ºld√©s, de ne ugr√°ljon el a layout
  ui.chatMsg.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      ui.chatSend.click();
    }
  });

  ui.readyBtn.onclick = ()=>{
    const cur = !!lobby.ready[clientId];
    send({ type:"intent", intent: cur ? "unready" : "ready" });
  };

  ui.actionFold.onclick = ()=> send({ type:"intent", intent:"action", action:"fold" });
  ui.actionCall.onclick = ()=> send({ type:"intent", intent:"action", action:"call" });
  ui.actionRaise.onclick = ()=> send({ type:"intent", intent:"action", action:"raise", amount:Number(ui.raiseAmt.value||0) });

  // Host buttons -> √∫j szerver intentek
  ui.startGameBtn.onclick = ()=> { if(!isHost()) return; send({ type:"intent", intent:"startGame" }); };
  ui.newHandBtn.onclick  = ()=> { if(!isHost()) return; send({ type:"intent", intent:"newHand" }); };
  ui.newGameBtn.onclick  = ()=> { if(!isHost()) return; send({ type:"intent", intent:"newGame" }); };

  ui.topupBtn.onclick = ()=>{
    if(!isHost()) return;
    const seatIdx = Number(ui.topupPlayer.value);
    const amt = Math.max(1, Number(ui.topupAmt.value || 0));
    send({ type:"intent", intent:"topup", seat: seatIdx, amount: amt });
  };

  // host config push
  function pushHostCfg(){
    if(!isHost()) return;
    const cfg = {
      bots: Number(ui.botCount.value||0),
      stack: Number(ui.stackSel.value||1000),
      blinds: ui.blindsSel.value
    };
    lobby.cfg = { ...lobby.cfg, ...cfg };
    send({ type:"intent", intent:"hostConfig", cfg });
  }
  ui.botCount.onchange = pushHostCfg;
  ui.stackSel.onchange = pushHostCfg;
  ui.blindsSel.onchange = pushHostCfg;

  // ====== Layout / seats
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function getSeatPos(i, n){
    const me = (mySeat == null ? 0 : mySeat);
    const rel = (i - me + n) % n;
    const angleStart = Math.PI / 2;
    const step = (2*Math.PI) / Math.max(2, n);
    const a = angleStart + rel * step;

    const rect = ui.tableEl.getBoundingClientRect();
    const rx = rect.width * 0.41;
    const ry = rect.height * 0.37;

    const cx = 50, cy = 50;
    let x = cx + (Math.cos(a) * (rx / rect.width) * 100);
    let y = cy + (Math.sin(a) * (ry / rect.height) * 100);

    x = clamp(x, 10, 90);
    y = clamp(y, 12, 88);
    return {x, y};
  }

  function amountToCall(st, p){
    return Math.max(0, (st.currentBet||0) - (p.bet||0));
  }

  function renderTable(st){
    ui.boardRow.innerHTML="";
    for(const c of (st.community||[])) ui.boardRow.appendChild(renderCard(c));

    ui.myHandRow.innerHTML = "";

    const myP = (mySeat!=null && st.players && st.players[mySeat]) ? st.players[mySeat] : null;
    if(myP && myP.hand && myP.hand.length===2){
      ui.myHandRow.appendChild(renderCard(myP.hand[0]));
      ui.myHandRow.appendChild(renderCard(myP.hand[1]));
    } else {
      ui.myHandRow.appendChild(faceDown());
      ui.myHandRow.appendChild(faceDown());
    }

    const players = st.players || [];
    const n = players.length;

    ui.seatLayer.innerHTML="";

    for(let i=0;i<n;i++){
      const p = players[i];
      const pos = getSeatPos(i, n);

      const el = document.createElement("div");
      el.className = "seat";
      el.style.left = pos.x + "%";
      el.style.top  = pos.y + "%";

      if(st.handActive && st.toAct===i) el.classList.add("toActBlink");
      if(p.folded) el.classList.add("folded");
      if(mySeat===i) el.classList.add("me");

      const badges = [];
      if(i===st.dealer) badges.push(`<span class="pill d">D</span>`);
      if(i===st.sbIndex) badges.push(`<span class="pill sb">SB</span>`);
      if(i===st.bbIndex) badges.push(`<span class="pill bb">BB</span>`);

      el.innerHTML = `
        <div class="topline">
          <div class="name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}${p.isBot?" ü§ñ":""}</div>
          <div class="meta">üí∞ ${p.stack}</div>
        </div>
        <div class="badges">${badges.join(" ")}</div>
        <div class="small" style="font-size:14px;font-weight:900;color:#ffcf5a">
          üí∞ T√©t: ${p.bet} ${p.folded ? "‚Ä¢ DOBOTT" : (p.allIn ? "‚Ä¢ ALL-IN" : "")}
        </div>
      `;

      // szerver showdownkor adja a handet √©s a komb√≥t
      if(p.hand && p.hand.length===2){
        const handRow = document.createElement("div");
        handRow.className = "handMini";
        handRow.appendChild(renderCard(p.hand[0]));
        handRow.appendChild(renderCard(p.hand[1]));
        el.appendChild(handRow);

        if(p._eval && p._eval.name){
          const ev = document.createElement("div");
          ev.className = "small";
          ev.textContent = `Komb√≥: ${p._eval.name}`;
          el.appendChild(ev);
        }
      }

      ui.seatLayer.appendChild(el);
    }
  }

  function render(){
    ui.host.textContent = hostId || "‚Äî";
    ui.seat.textContent = (mySeat==null ? "‚Äî" : String(mySeat));
    ui.startInfo.textContent = lobby.started ? "J√°t√©k fut" : "V√°rakoz√°s (K√©sz / Ready)‚Ä¶";

    ui.tabHost.classList.toggle("hidden", !isHost());

    const isReady = lobby.ready[clientId] === true;
    ui.readyBtn.textContent = isReady ? "K√âSZ ‚úî" : "K√âSZ / READY";
    ui.readyBtn.classList.toggle("readyOn", isReady);

    // Players list (chat tab bal oldalt)
    ui.players.innerHTML = "";
    for(const h of (lobby.humans||[]).slice().sort((a,b)=>a.seat-b.seat)){
      const row=document.createElement("div");
      row.className="pitem";

      const left=document.createElement("div");
      left.textContent = h.name;

      const money=document.createElement("div");
      money.style.fontSize="12px";
      money.style.color="#bfe6d9";
      const stack = state?.players?.[h.seat]?.stack;
      money.textContent = `üí∞ ${stack ?? "‚Äî"}`;

      const right=document.createElement("span");
      const ok = lobby.ready[h.clientId] === true;
      right.className = "pill " + (ok ? "ready" : "notready");
      right.textContent = ok ? "K√âSZ" : "NEM K√âSZ";

      row.appendChild(left);
      row.appendChild(money);
      row.appendChild(right);
      ui.players.appendChild(row);
    }

    // Host topup select
    if(isHost() && ui.topupPlayer){
      ui.topupPlayer.innerHTML = "";
      const humansSorted = (lobby.humans||[]).slice().sort((a,b)=>a.seat-b.seat);
      for(const h of humansSorted){
        const stck = state?.players?.[h.seat]?.stack;
        const opt = document.createElement("option");
        opt.value = String(h.seat);
        opt.textContent = (stck==null) ? `${h.name} (seat ${h.seat})` : `${h.name} (${stck})`;
        ui.topupPlayer.appendChild(opt);
      }
    }

    // Disable topup during hand
    ui.topupBtn.disabled = !isHost() || !state || (state && state.handActive);

    // if no game yet
    if(!lobby.started || !state){
      ui.streetLbl.textContent = "‚Äî";
      ui.currentBetLbl.textContent = "0";
      ui.potLbl.textContent = "0";
      ui.handNoLbl.textContent = "0";

      ui.actionFold.disabled = true;
      ui.actionCall.disabled = true;
      ui.actionRaise.disabled = true;
      ui.yourTurnBox.classList.add("hidden");

      ui.turnHint.textContent = isHost()
        ? "Hostk√©nt ind√≠tsd a j√°t√©kot a Host f√ºl√∂n."
        : "V√°rakoz√°s a host ind√≠t√°s√°ra‚Ä¶";

      ui.winnerBanner.classList.add("hidden");
      ui.boardRow.innerHTML="";
      ui.myHandRow.innerHTML="";
      ui.seatLayer.innerHTML="";
      return;
    }

    ui.streetLbl.textContent = ({PREFLOP:"Preflop",FLOP:"Flop",TURN:"Turn",RIVER:"River",SHOWDOWN:"Showdown"}[state.street]||state.street);
    ui.currentBetLbl.textContent = String(state.currentBet || 0);
    ui.potLbl.textContent = String(state.pot || 0);
    ui.handNoLbl.textContent = String(state.handNo || 0);

    renderTable(state);

    const seatValid = (mySeat != null && state.players && mySeat >= 0 && mySeat < state.players.length);
    const canAct = seatValid && state.handActive && state.toAct===mySeat;

    ui.actionFold.disabled = !canAct;
    ui.actionCall.disabled = !canAct;
    ui.actionRaise.disabled = !canAct;
    ui.yourTurnBox.classList.toggle("hidden", !canAct);

    // PASS <-> MEGAD: X
    if (canAct) {
      const meP = state.players[mySeat];
      const need = amountToCall(state, meP);
      ui.actionCall.textContent = (need > 0) ? `MEGAD: ${need}` : "PASS";

      // raise input seg√≠ts√©g: tegy√ºk minimumra a k√∂vetkez≈ë ‚Äúnorm√°l‚Äù emel√©st (currentBet + BB)
      const bb = Number(state.cfg?.bb || 20);
      const suggestedMin = Math.max((state.currentBet || 0) + bb, bb);
      ui.raiseAmt.min = String(suggestedMin);
      if(Number(ui.raiseAmt.value || 0) < suggestedMin) ui.raiseAmt.value = String(suggestedMin);
      ui.raiseAmt.step = String(bb || 10);
    } else {
      ui.actionCall.textContent = "PASS";
    }

    // Showdown banner
    if ((state.street === "SHOWDOWN" || !state.handActive) && state.showdownInfo?.winners?.length){
      const w = state.showdownInfo.winners.join(", ");
      ui.winnerBanner.textContent = `üèÜ Nyertes: ${w} ‚Äî ${state.showdownInfo.handName}`;
      ui.winnerBanner.classList.remove("hidden");
    } else {
      ui.winnerBanner.classList.add("hidden");
    }

    if(!seatValid){
      ui.turnHint.textContent = "A sz√©ked nem r√©sze ennek a fut√≥ j√°t√©knak. V√°rj √∫j j√°t√©kra (Host: √öJ J√ÅT√âK).";
      return;
    }

    if(!state.handActive){
      ui.turnHint.textContent = isHost()
        ? "Leoszt√°s v√©ge. Host: √öJ K√ñR / √öJ J√ÅT√âK (Host f√ºl√∂n)."
        : "Leoszt√°s v√©ge. V√°rakoz√°s a hostra (√öJ K√ñR / √öJ J√ÅT√âK).";
    } else {
      const actor = state.players[state.toAct];
      const callAmt = amountToCall(state, actor);
      if(state.toAct === mySeat){
        ui.turnHint.textContent = callAmt===0
          ? `Te vagy soron: PASS / EMEL√âS / DOB√ÅS.`
          : `Te vagy soron: MEGAD√ÅS ${callAmt} / EMEL√âS / DOB√ÅS.`;
      } else {
        ui.turnHint.textContent = `${actor.name} k√∂vetkezik‚Ä¶ ${actor.isBot ? "(robot gondolkodik‚Ä¶)" : ""}`;
      }
    }
  }

  // ====== Connect WS
  function connect(){
    ui.status.textContent = "csatlakoz√°s‚Ä¶";
    ws = new WebSocket(wsUrl);

    ws.addEventListener("open", ()=>{
      ui.status.textContent = "online";
      send({ type:"join", room, name, pw });
    });

    ws.addEventListener("close", ()=> ui.status.textContent = "offline");
    ws.addEventListener("error", ()=> ui.status.textContent = "hiba");

    ws.addEventListener("message", (ev)=>{
      let msg;
      try{ msg = JSON.parse(ev.data); } catch { return; }

      if(msg.type==="welcome"){
        clientId = msg.clientId;
        hostId = msg.hostId;
        mySeat = Number(msg.seat);
        send({ type:"getLobby" });
        render();
        return;
      }

      if(msg.type==="hostChanged"){
        hostId = msg.hostId;
        render();
        return;
      }

      if(msg.type==="lobby"){
        lobby = msg.lobby;
        hostId = msg.hostId;
        render();
        return;
      }

      // √∫j szerver: mindig state-et k√ºld
      if(msg.type==="state"){
        state = msg.state;
        render();
        return;
      }

      if(msg.type==="chat"){
        appendChat(msg.name, msg.text);
        return;
      }

      if(msg.type==="error"){
        alert(msg.message || "Hiba");
        return;
      }
    });

    // ‚úÖ resize: csak √∫jrarajzol√°s
    window.addEventListener("resize", ()=> { if(state) render(); });
  }

  connect();
</script>
</body>
</html>
