<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Texas Hold'em ‚Äì Online (Fix)</title>

  <style>
    :root{
      --bg:#0b3d2e;--text:#eaf7f2;--muted:#bfe6d9;--acc:#ffcf5a;
      --line:rgba(255,255,255,.14);--danger:#ff4d4d;--ok:#6bffb1;
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,Arial;
      background:radial-gradient(1200px 800px at 50% 15%, #14624a, var(--bg));
      color:var(--text);

      /* ‚úÖ FIX: ne sz√°molgassunk fix fejl√©ccel, ink√°bb flex */
      display:flex;
      flex-direction:column;

      /* ‚úÖ FIX: az oldal ne a body-n scrollozzon */
      overflow:hidden;
    }

    header{
      flex:0 0 auto;
      padding:10px 12px;
      display:flex;gap:10px;justify-content:space-between;align-items:center;
      background:rgba(0,0,0,.18);
      border-bottom:1px solid var(--line);
      flex-wrap:wrap;
    }

    .badge{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted)}
    .badge.bigMoney{font-size:16px;font-weight:900;color:var(--acc)}
    .big{font-size:16px;font-weight:900;color:var(--acc)}

    select,button,input{border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--text);padding:10px;border-radius:12px;outline:none}
    button{cursor:pointer;font-weight:900}
    button:disabled{opacity:.5;cursor:not-allowed}
    button.readyOn{background:rgba(31,122,74,.45);border-color:rgba(107,255,177,.55);color:#eafff4}

    .app{
      /* ‚úÖ FIX: a marad√©k helyet t√∂ltse ki a header alatt */
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;

      /* ‚úÖ FIX: az app-on bel√ºl kezelj√ºk a g√∂rget√©st, ne a body-n */
      overflow:hidden;
    }

    .topbar{
      flex:0 0 auto;
      display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    .tabs{display:flex;gap:8px}
    .tab{min-width:120px;display:flex;align-items:center;justify-content:center;gap:8px}
    .tab.active{border-color:rgba(255,207,90,.6);box-shadow:0 0 0 6px rgba(255,207,90,.08)}
    .hidden{display:none}

    .panel{
      flex:1 1 auto;
      min-height:0;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.16);
      padding:12px;
      position:relative;

      /* ‚úÖ FIX: panel ne n√∂vessze t√∫l a k√©perny≈ët */
      overflow:hidden;
    }

    .gameView{
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:0;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    /* ===== TABLE + HUD ===== */
    .tableWrap{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:10px;
      align-items:stretch;
      justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(255,255,255,.06);
      padding:10px;
      overflow:hidden;
    }

    .table{
      position:relative;
      width:100%;
      height:100%;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.25), transparent 45%),
        repeating-linear-gradient(45deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 6px, transparent 6px, transparent 12px),
        radial-gradient(ellipse at center, #0f5a3f, #083b2a);
      box-shadow: inset 0 0 60px rgba(0,0,0,.55), 0 20px 60px rgba(0,0,0,.45);
    }
    .table::before{content:"";position:absolute; inset:18px;border-radius:999px;border:1px dashed rgba(255,255,255,.14)}

    .boardCenter{
      position:absolute;left:50%; top:50%;transform:translate(-50%,-50%);
      width:min(740px, 94%);
      padding:10px 8px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);text-align:center
    }
    .boardRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;min-height:72px}
    .myHandRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}

    .card{width:46px;height:64px;background:#f7f7f7;color:#1b1b1b;border-radius:10px;display:flex;flex-direction:column;justify-content:space-between;padding:6px;border:1px solid rgba(0,0,0,.12)}
    .card.red{color:#c21d1d}

    .seat{
      position:absolute;width:160px;padding:8px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);
      transform:translate(-50%,-50%);font-size:11px;line-height:1.2;
    }
    .seat .topline{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .seat .name{font-weight:900;color:var(--text);max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .seat .meta{color:var(--muted);white-space:nowrap}
    .seat .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .seat .small{margin-top:6px;color:var(--muted)}
    .seat.folded{opacity:.55}
    .seat.me{border-color:rgba(107,255,177,.35)}
    .seat .handMini{display:flex;gap:6px;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .seat .handMini .card{transform:scale(.72);transform-origin:center}

    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .pill.sb{border-color:rgba(255,207,90,.45);color:var(--acc)}
    .pill.bb{border-color:rgba(255,207,90,.85);color:var(--acc)}
    .pill.d{border-color:rgba(255,207,90,.25);color:var(--acc)}
    .pill.ready{border-color:rgba(107,255,177,.4);color:var(--ok)}
    .pill.notready{border-color:rgba(255,107,107,.4);color:var(--danger)}

    @keyframes blinkRed {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,77,77,.0); }
      50% { box-shadow: 0 0 0 14px rgba(255,77,77,.22); }
    }
    .seat.toActBlink{
      outline: 5px solid rgba(255,77,77,1);
      animation: blinkRed 0.85s infinite;
      box-shadow:
        0 0 0 6px rgba(255,77,77,.25),
        0 0 25px rgba(255,77,77,.65),
        inset 0 0 18px rgba(255,77,77,.25);
    }
    .turnDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--danger);box-shadow:0 0 10px rgba(255,77,77,.6);animation:blinkRed 0.85s infinite;margin-right:8px;}

    /* ===== ACTION HUD ===== */
    .actionPanel{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:12px;
      border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      min-width:0;
    }
    .actionPanel button, .actionPanel input{width:100%}
    .turnBox{
      padding:8px 10px;border-radius:14px;border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.08);display:flex;align-items:center;font-weight:900;color:#ffd5d5;
    }
    .turnBox.hidden{display:none}

    .winnerBanner{
      margin-top:10px;
      padding:10px 12px;
      border-radius:16px;
      border:2px solid rgba(255,207,90,.55);
      background:rgba(0,0,0,.42);
      font-weight:1000;
      font-size:22px;
      letter-spacing:.3px;
      color:#ffe6a6;
      text-shadow:0 2px 14px rgba(0,0,0,.55);
    }
    .winnerBanner.hidden{display:none}

    /* CHAT VIEW */
    .chatGrid{
      height:100%;
      min-height:0;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:10px;
    }

    .scrollBox{
      min-height:0;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.06)
    }

    .playersList .pitem{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12);align-items:center}
    .playersList .pitem:last-child{border-bottom:none}

    /* ‚úÖ FIX: chatbox ne 100% magass√°got akarjon, hanem t√∂ltse a marad√©kot */
    .chatRight{
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .chatbox{
      flex:1;
      min-height:0;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,.18);
      white-space:pre-wrap
    }

    .chatline{margin:0 0 8px 0;color:var(--muted)}
    .chatline b{color:var(--acc)}
    .mention{color:var(--acc);font-weight:900}

    .chatSend{display:flex;gap:8px}
    .chatSend input{flex:1}

    #chatNotif{background:#ff4d4d;color:white;font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid rgba(0,0,0,.18)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}

    @media (max-width: 980px){
      /* mobilon is maradjon stabil, ne a body scrollozzon */
      .chatGrid{grid-template-columns:1fr}
      .tableWrap{grid-template-columns:1fr}
      .tableWrap{min-height:520px}
    }
  </style>
</head>

<body>
<header>
  <div class="row" style="gap:10px">
    <span class="badge">Szoba: <b id="room"></b></span>
    <span class="badge">Te: <b id="me"></b></span>
    <span class="badge">Kapcsolat: <b id="status">‚Äî</b></span>
    <span class="badge">Sz√©k: <b id="seat">‚Äî</b></span>
    <span class="badge">Host: <b id="host">‚Äî</b></span>
  </div>
  <div class="big" id="startInfo">V√°rakoz√°s (K√©sz / Ready)‚Ä¶</div>
</header>

<div class="app">
  <div class="topbar">
    <div class="row" style="gap:10px">
      <button id="readyBtn">K√âSZ / READY</button>
      <span class="badge">Utca: <b id="streetLbl">‚Äî</b></span>
      <span class="badge bigMoney">Aktu√°lis t√©t: <b id="currentBetLbl">0</b></span>
      <span class="badge bigMoney">üí∞ Pot: <b id="potLbl">0</b></span>
      <span class="badge">K√∂r: <b id="handNoLbl">0</b></span>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabGame">J√°t√©k</button>
      <button class="tab" id="tabChat">Chat <span id="chatNotif" class="pill hidden">‚óè</span></button>
      <button class="tab hidden" id="tabHost">Host</button>
    </div>
  </div>

  <!-- GAME -->
  <section class="panel gameView" id="viewGame">
    <div class="tableWrap">
      <div class="table" id="table">
        <div class="boardCenter">
          <div class="badge" style="display:inline-block;margin-bottom:8px">K√∂z√∂s lapok</div>
          <div class="boardRow" id="boardRow"></div>

          <div class="badge" style="display:inline-block;margin:10px 0 6px 0">Saj√°t lapjaid</div>
          <div class="myHandRow" id="myHandRow"></div>

          <div class="hint" id="turnHint" style="margin-top:8px;font-size:13px">‚Äî</div>
          <div id="winnerBanner" class="winnerBanner hidden"></div>
        </div>
        <div id="seatLayer"></div>
      </div>

      <!-- ACTION HUD -->
      <div class="actionPanel">
        <div id="yourTurnBox" class="turnBox hidden"><span class="turnDot"></span>TE VAGY SORON!</div>
        <button id="actionCall">PASS</button>
        <button id="actionFold">DOB√ÅS</button>

        <!-- ‚úÖ FIX: ez most r√°emel√©s (+), nem "X-ig" -->
        <input id="raiseAmt" type="number" value="40" min="0" step="10" />
        <button id="actionRaise">EMEL√âS (+)</button>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section class="panel hidden" id="viewChat">
    <div class="chatGrid">
      <div class="scrollBox playersList" id="playersBox">
        <div class="badge">J√°t√©kosok</div>
        <div class="hint">N√©v ‚Ä¢ üí∞ egyenleg ‚Ä¢ K√âSZ</div>
        <div id="players" style="margin-top:10px"></div>
      </div>

      <div class="chatRight">
        <div class="badge">Chat</div>
        <div class="chatbox" id="chatBox"></div>

        <div class="chatSend">
          <input id="chatMsg" placeholder="√çrj valamit‚Ä¶ (@Bruno)" maxlength="300" />
          <button id="chatSend">K√ºld√©s</button>
        </div>
        <div class="hint">Taggel√©s: √≠rd be pl. <b>@Bruno</b> vagy <b>@Csongor</b></div>
      </div>
    </div>
  </section>

  <!-- HOST -->
  <section class="panel hidden" id="viewHost">
    <div>
      <div class="badge">Host be√°ll√≠t√°sok</div>
      <div class="hint">√öj j√°t√©k param√©terei + k√∂r v√©g√©n zseton ad√°s.</div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
        <label class="badge">Robotok:
          <select id="botCount">
            <option value="0">0</option><option value="1">1</option><option value="2">2</option>
            <option value="3" selected>3</option><option value="4">4</option><option value="5">5</option>
            <option value="6">6</option><option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
          </select>
        </label>

        <label class="badge">Kezd≈ë zseton:
          <select id="stackSel">
            <option value="500">500</option><option value="1000" selected>1000</option><option value="2000">2000</option><option value="5000">5000</option>
          </select>
        </label>

        <label class="badge">Vakok (SB/BB):
          <select id="blindsSel">
            <option value="5,10">5/10</option>
            <option value="10,20" selected>10/20</option>
            <option value="25,50">25/50</option>
            <option value="50,100">50/100</option>
          </select>
        </label>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="startGameBtn">‚ñ∂ J√ÅT√âK IND√çT√ÅSA</button>
        <button id="newHandBtn">üîÑ √öJ K√ñR</button>
        <button id="newGameBtn">üîÅ √öJ J√ÅT√âK</button>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
        <label class="badge">J√°t√©kos:
          <select id="topupPlayer"></select>
        </label>
        <label class="badge">√ñsszeg:
          <input id="topupAmt" type="number" value="500" min="1" step="50" style="width:120px" />
        </label>
        <button id="topupBtn">‚ûï Zseton ad√°sa</button>
      </div>
      <div class="hint">Zsetont adni <b>k√∂r v√©g√©n</b> lehet.</div>
    </div>
  </section>
</div>

<script>
  // ---------------------------
  // Boot / params
  // ---------------------------
  const qs = new URLSearchParams(location.search);
  const room = (qs.get("room")||"").trim();
  const name = (qs.get("name")||"").trim();
  const wsUrl = (qs.get("ws")||"").trim();
  const pw = sessionStorage.getItem("poker_room_pw") || "";

  if(!room || !name || !wsUrl || !pw){
    alert("Hi√°nyzik a szoba / n√©v / ws / jelsz√≥. Menj vissza a lobbyba!");
    location.href = "pokerlobby.html";
  }

  const ui = {
    room: document.getElementById("room"),
    me: document.getElementById("me"),
    status: document.getElementById("status"),
    seat: document.getElementById("seat"),
    host: document.getElementById("host"),
    startInfo: document.getElementById("startInfo"),

    streetLbl: document.getElementById("streetLbl"),
    currentBetLbl: document.getElementById("currentBetLbl"),
    potLbl: document.getElementById("potLbl"),
    handNoLbl: document.getElementById("handNoLbl"),

    tabGame: document.getElementById("tabGame"),
    tabChat: document.getElementById("tabChat"),
    tabHost: document.getElementById("tabHost"),
    chatNotif: document.getElementById("chatNotif"),

    viewGame: document.getElementById("viewGame"),
    viewChat: document.getElementById("viewChat"),
    viewHost: document.getElementById("viewHost"),

    readyBtn: document.getElementById("readyBtn"),

    boardRow: document.getElementById("boardRow"),
    myHandRow: document.getElementById("myHandRow"),
    seatLayer: document.getElementById("seatLayer"),
    tableEl: document.getElementById("table"),
    turnHint: document.getElementById("turnHint"),
    winnerBanner: document.getElementById("winnerBanner"),

    actionFold: document.getElementById("actionFold"),
    actionCall: document.getElementById("actionCall"),
    actionRaise: document.getElementById("actionRaise"),
    raiseAmt: document.getElementById("raiseAmt"),
    yourTurnBox: document.getElementById("yourTurnBox"),

    players: document.getElementById("players"),
    chatBox: document.getElementById("chatBox"),
    chatMsg: document.getElementById("chatMsg"),
    chatSend: document.getElementById("chatSend"),

    botCount: document.getElementById("botCount"),
    stackSel: document.getElementById("stackSel"),
    blindsSel: document.getElementById("blindsSel"),
    startGameBtn: document.getElementById("startGameBtn"),
    newHandBtn: document.getElementById("newHandBtn"),
    newGameBtn: document.getElementById("newGameBtn"),
    topupPlayer: document.getElementById("topupPlayer"),
    topupAmt: document.getElementById("topupAmt"),
    topupBtn: document.getElementById("topupBtn"),
  };

  ui.room.textContent = room;
  ui.me.textContent = name;

  // ---------------------------
  // Tabs
  // ---------------------------
  function switchTab(which){
    ui.tabGame.classList.toggle("active", which==="game");
    ui.tabChat.classList.toggle("active", which==="chat");
    ui.tabHost.classList.toggle("active", which==="host");

    ui.viewGame.classList.toggle("hidden", which!=="game");
    ui.viewChat.classList.toggle("hidden", which!=="chat");
    ui.viewHost.classList.toggle("hidden", which!=="host");

    if(which==="chat") ui.chatNotif.classList.add("hidden");
  }
  ui.tabGame.onclick = ()=>switchTab("game");
  ui.tabChat.onclick = ()=>switchTab("chat");
  ui.tabHost.onclick = ()=>switchTab("host");
  switchTab("game");

  // ---------------------------
  // Helpers
  // ---------------------------
  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  const SUITS=["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const RANKS=["2","3","4","5","6","7","8","9","10","J","Q","K","A"];
  const RANK_VALUE=Object.fromEntries(RANKS.map((r,i)=>[r,i+2]));
  function isRedSuit(s){ return s==="‚ô•" || s==="‚ô¶"; }

  function renderCard(c){
    const d=document.createElement("div");
    d.className="card"+(isRedSuit(c.s)?" red":"");
    d.innerHTML = `<div style="font-weight:900;font-size:16px;line-height:1">${c.r}</div>
                   <div style="align-self:flex-end;font-size:16px;line-height:1">${c.s}</div>`;
    return d;
  }
  function faceDown(){
    const d=document.createElement("div");
    d.className="card";
    d.style.background="rgba(0,0,0,.18)";
    d.style.color="rgba(255,255,255,.65)";
    d.innerHTML="<div style='font-weight:900'>?</div><div style='align-self:flex-end'>üÇ†</div>";
    return d;
  }
  function makeDeck(){
    const d=[]; for(const s of SUITS) for(const r of RANKS) d.push({r,s}); return d;
  }
  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function findStraightHigh(uniqueValsDesc){
    const set=new Set(uniqueValsDesc);
    const wheel=[14,5,4,3,2];
    if(wheel.every(v=>set.has(v))) return 5;
    for(const high of uniqueValsDesc){
      let ok=true;
      for(let d=1;d<=4;d++){ if(!set.has(high-d)){ ok=false; break; } }
      if(ok) return high;
    }
    return null;
  }

  function evaluate7(cards){
    const vals=cards.map(c=>RANK_VALUE[c.r]).sort((a,b)=>b-a);
    const byRank=new Map();
    for(const c of cards){ const v=RANK_VALUE[c.r]; byRank.set(v,(byRank.get(v)||0)+1); }
    const groups=[...byRank.entries()].map(([v,c])=>({v,c})).sort((a,b)=>(b.c-a.c)||(b.v-a.v));

    const bySuit=new Map();
    for(const c of cards){ if(!bySuit.has(c.s)) bySuit.set(c.s,[]); bySuit.get(c.s).push(RANK_VALUE[c.r]); }
    for(const [s,arr] of bySuit) arr.sort((a,b)=>b-a);

    const flushSuit=[...bySuit.entries()].find(([s,arr])=>arr.length>=5)?.[0] ?? null;
    const unique=[...new Set(vals)];
    const straight=findStraightHigh(unique);

    let sf=null;
    if(flushSuit){
      const fv=[...new Set(bySuit.get(flushSuit))].sort((a,b)=>b-a);
      sf=findStraightHigh(fv);
    }

    if(sf) return {cat:8,t:[sf],name:"sz√≠nsor"};
    if(groups[0]?.c===4){ const q=groups[0].v; const k=unique.find(v=>v!==q); return {cat:7,t:[q,k],name:"p√≥ker"}; }
    if(groups[0]?.c===3 && groups[1]?.c>=2) return {cat:6,t:[groups[0].v,groups[1].v],name:"full house"};
    if(flushSuit) return {cat:5,t:bySuit.get(flushSuit).slice(0,5),name:"sz√≠n"};
    if(straight) return {cat:4,t:[straight],name:"sor"};
    if(groups[0]?.c===3){
      const tr=groups[0].v;
      const k=unique.filter(v=>v!==tr).slice(0,2);
      return {cat:3,t:[tr,...k],name:"drill"};
    }
    if(groups[0]?.c===2 && groups[1]?.c===2){
      const hi=Math.max(groups[0].v,groups[1].v), lo=Math.min(groups[0].v,groups[1].v);
      const k=unique.find(v=>v!==hi && v!==lo);
      return {cat:2,t:[hi,lo,k],name:"k√©t p√°r"};
    }
    if(groups[0]?.c===2){
      const pr=groups[0].v;
      const k=unique.filter(v=>v!==pr).slice(0,3);
      return {cat:1,t:[pr,...k],name:"p√°r"};
    }
    return {cat:0,t:unique.slice(0,5),name:"magas lap"};
  }

  function cmpEval(a,b){
    if(a.cat!==b.cat) return a.cat>b.cat?1:-1;
    for(let i=0;i<Math.max(a.t.length,b.t.length);i++){
      const av=a.t[i]??0, bv=b.t[i]??0;
      if(av!==bv) return av>bv?1:-1;
    }
    return 0;
  }

  // ---------------------------
  // WebSocket state
  // ---------------------------
  let ws=null, clientId=null, hostId=null, mySeat=null;

  let lobby = { humans:[], ready:{}, cfg:{bots:3, stack:1000, blinds:"10,20"}, started:false };
  let state = null;
  let hostState = null;

  function isHost(){ return clientId && hostId && clientId===hostId; }
  function send(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

  // ---------------------------
  // Chat
  // ---------------------------
  function highlightMentionsSafe(text){
    const safe = escapeHtml(text);
    return safe.replace(/@([^\s]+)/g, (m,p1)=>`<span class="mention">@${p1}</span>`);
  }

  function isNearBottom(el, px=40){
    return el.scrollHeight - el.scrollTop - el.clientHeight < px;
  }

  function appendChat(n,t){
    const stick = isNearBottom(ui.chatBox);
    const p=document.createElement("p");
    p.className="chatline";
    p.innerHTML = `<b>${escapeHtml(n)}:</b> ${highlightMentionsSafe(t)}`;
    ui.chatBox.appendChild(p);

    if(stick) ui.chatBox.scrollTop = ui.chatBox.scrollHeight;

    if(ui.viewChat.classList.contains("hidden")) ui.chatNotif.classList.remove("hidden");
  }

  ui.chatSend.onclick = ()=>{
    const text = ui.chatMsg.value.trim().slice(0,300);
    if(!text) return;
    ui.chatMsg.value="";
    send({ type:"intent", intent:"chat", text });
  };
  ui.chatMsg.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      ui.chatSend.click();
    }
  });

  // ---------------------------
  // Ready
  // ---------------------------
  ui.readyBtn.onclick = ()=>{
    const cur = !!lobby.ready[clientId];
    send({ type:"intent", intent: cur ? "unready" : "ready" });
  };
  function everyoneReady(){
    return lobby.humans.length>0 && lobby.humans.every(h => lobby.ready[h.clientId] === true);
  }

  // ---------------------------
  // Host cfg
  // ---------------------------
  function pushHostCfg(){
    if(!isHost()) return;
    const cfg = {
      bots: Number(ui.botCount.value||0),
      stack: Number(ui.stackSel.value||1000),
      blinds: ui.blindsSel.value
    };
    lobby.cfg = { ...lobby.cfg, ...cfg };
    send({ type:"intent", intent:"hostConfig", cfg });
  }
  ui.botCount.onchange = pushHostCfg;
  ui.stackSel.onchange = pushHostCfg;
  ui.blindsSel.onchange = pushHostCfg;

  // ---------------------------
  // Poker engine (host)
  // ---------------------------
  function nextEligibleIndex(st, from){
    const n=st.players.length;
    for(let t=1;t<=n;t++){
      const idx=(from+t)%n;
      const p=st.players[idx];
      if(p.inHand && !p.folded) return idx;
    }
    return from;
  }
  function nextActionIndex(st, from){
    const n=st.players.length;
    for(let t=1;t<=n;t++){
      const idx=(from+t)%n;
      const p=st.players[idx];
      if(p.inHand && !p.folded && !p.allIn) return idx;
    }
    return null;
  }
  function countAlive(st){ return st.players.filter(p=>p.inHand && !p.folded).length; }
  function amountToCall(st,p){ return Math.max(0, st.currentBet - p.bet); }

  function bettingClosed(st){
    if(countAlive(st)<=1) return true;
    const elig=st.players.filter(p=>p.inHand && !p.folded && !p.allIn);
    if(elig.length===0) return true;
    const acted=new Set(st.acted||[]);
    for(const p of elig){
      if(p.bet!==st.currentBet) return false;
      if(!acted.has(p.id)) return false;
    }
    return true;
  }

  function hist(st, text){
    st.history = st.history || [];
    st.history.push(text);
    if(st.history.length > 250) st.history.shift();
    st.msg = text;
  }

  function postBlind(st, idx, amt, label){
    const p=st.players[idx];
    const pay=Math.min(amt, p.stack);
    p.stack-=pay; p.bet+=pay; p.totalInvested+=pay; st.pot+=pay;
    if(p.stack===0) p.allIn=true;
    hist(st, `${p.name} posztolja: ${label} ${pay}`);
  }

  function startHand(st){
    st.handNo++;
    st.history = [];
    st.showdownInfo = null;
    st.showAllHands = false;
    hist(st, `=== ${st.handNo}. k√∂r indul ===`);

    st.deck = shuffle(makeDeck());
    st.community=[];
    st.pot=0;
    st.street="PREFLOP";
    st.currentBet=0;
    st.acted=[];
    st.handActive=true;

    for(const p of st.players){
      p.hand=[];
      p.inHand = p.stack>0;
      p.folded = !p.inHand;
      p.allIn=false;
      p.bet=0;
      p.totalInvested=0;
      p._eval=null;
    }

    st.dealer = nextEligibleIndex(st, st.dealer);

    for(let k=0;k<2;k++){
      for(let i=0;i<st.players.length;i++){
        const idx=(st.dealer+1+i)%st.players.length;
        if(st.players[idx].inHand) st.players[idx].hand.push(st.deck.pop());
      }
    }

    st.sbIndex = nextEligibleIndex(st, st.dealer);
    st.bbIndex = nextEligibleIndex(st, st.sbIndex);

    postBlind(st, st.sbIndex, st.cfg.sb, "SB");
    postBlind(st, st.bbIndex, st.cfg.bb, "BB");

    st.currentBet = Math.max(...st.players.map(p=>p.bet));
    st.toAct = nextEligibleIndex(st, st.bbIndex);
    st.acted = [];
    hist(st, `Preflop indul. Aktu√°lis t√©t: ${st.currentBet}.`);
  }

  function actFold(st, idx){
    st.players[idx].folded=true;
    st.acted.push(st.players[idx].id);
    hist(st, `${st.players[idx].name}: dob√°s`);

    if(countAlive(st)<=1){
      const w=st.players.find(p=>p.inHand && !p.folded);
      if(w) w.stack += st.pot;
      st.handActive=false;
      st.street="SHOWDOWN";
      st.showdownInfo = w ? { winners:[w.name], handName:"mindenki dobott" } : null;

      // ‚úÖ FIX: ha mindenki dobott, ne mutassunk lapokat
      st.showAllHands = false;

      hist(st, `Mindenki dobott. Nyertes: ${w?.name ?? "‚Äî"} (+${st.pot})`);
      return;
    }
    st.toAct = bettingClosed(st) ? null : nextActionIndex(st, idx);
  }

  function actCallCheck(st, idx){
    const p=st.players[idx];
    const call=amountToCall(st,p);
    const pay=Math.min(call, p.stack);
    p.stack-=pay; p.bet+=pay; p.totalInvested+=pay; st.pot+=pay;
    if(p.stack===0 && call>0) p.allIn=true;

    if(call===0) hist(st, `${p.name}: passz`);
    else hist(st, `${p.name}: megad ${pay}${pay<call ? " (all-in)" : ""}`);

    st.acted.push(p.id);
    st.toAct = bettingClosed(st) ? null : nextActionIndex(st, idx);
  }

  // ‚úÖ FIX: emel√©s most "r√°emel√©s" (+), nem "X-ig"
  function actRaiseBy(st, idx, raiseByRaw){
    const p=st.players[idx];
    let raiseBy = Math.max(0, Number(raiseByRaw||0));

    // minim√°lis logika: legal√°bb BB-t r√°emeljen (ha van stack)
    const minRaise = st.cfg.bb;
    if(raiseBy > 0 && raiseBy < minRaise) raiseBy = minRaise;

    const target = st.currentBet + raiseBy;
    if(target <= st.currentBet){
      actCallCheck(st, idx);
      return;
    }

    const need = Math.max(0, target - p.bet);
    const pay = Math.min(need, p.stack);
    p.stack -= pay;
    p.bet += pay;
    p.totalInvested += pay;
    st.pot += pay;

    if(p.stack===0) p.allIn=true;

    st.currentBet = p.bet; // az aktu√°lis t√©t szintje
    st.acted = [p.id];     // aki emelt, az √∫jraind√≠tja, hogy a t√∂bbiek reag√°ljanak
    hist(st, `${p.name}: emel (+${raiseBy}) ‚Üí ${st.currentBet}${p.allIn ? " (all-in)" : ""}`);

    st.toAct = bettingClosed(st) ? null : nextActionIndex(st, idx);
  }

  function advanceStreet(st){
    if(!st.handActive) return;
    if(!bettingClosed(st)) return;

    if(countAlive(st)<=1){
      const w=st.players.find(p=>p.inHand && !p.folded);
      if(w) w.stack += st.pot;
      st.handActive=false;
      st.street="SHOWDOWN";
      st.showdownInfo = w ? { winners:[w.name], handName:"mindenki dobott" } : null;
      st.showAllHands = false; // ‚úÖ FIX
      hist(st, `Nyertes: ${w?.name ?? "‚Äî"} (+${st.pot})`);
      return;
    }

    for(const p of st.players) p.bet = 0;
    st.currentBet = 0;
    st.acted = [];
    st.toAct = nextEligibleIndex(st, st.dealer);

    if(st.street==="PREFLOP"){
      st.deck.pop(); st.community.push(st.deck.pop(), st.deck.pop(), st.deck.pop());
      st.street="FLOP"; hist(st, "Flop.");
    } else if(st.street==="FLOP"){
      st.deck.pop(); st.community.push(st.deck.pop());
      st.street="TURN"; hist(st, "Turn.");
    } else if(st.street==="TURN"){
      st.deck.pop(); st.community.push(st.deck.pop());
      st.street="RIVER"; hist(st, "River.");
    } else if(st.street==="RIVER"){
      st.street="SHOWDOWN";
      doShowdown(st);
    }
  }

  function doShowdown(st){
    const alive = st.players.filter(p => p.inHand && !p.folded);
    if(alive.length===0){ st.handActive=false; hist(st,"Showdown: nincs akt√≠v j√°t√©kos."); return; }

    for(const p of alive){
      p._eval = evaluate7(p.hand.concat(st.community));
    }

    let best = alive[0]._eval;
    for(const p of alive){
      if(cmpEval(p._eval, best) > 0) best = p._eval;
    }
    const winnersOverall = alive.filter(p => cmpEval(p._eval, best) === 0).map(p=>p.name);
    st.showdownInfo = { winners: winnersOverall, handName: best.name };

    // ‚úÖ FIX: showdownban igen, mutatjuk
    st.showAllHands = true;

    // side pot / all-in kifizet√©s
    const investedAll = st.players
      .map(p => ({ id: p.id, invested: Number(p.totalInvested||0) }))
      .filter(x => x.invested > 0)
      .sort((a,b)=>a.invested-b.invested);

    if(investedAll.length===0){ st.handActive=false; hist(st,"Showdown: √ºres pot."); return; }

    const levels = [...new Set(investedAll.map(x=>x.invested))].sort((a,b)=>a-b);
    const won = new Map(st.players.map(p => [p.id, 0]));
    let prev = 0;

    for(const L of levels){
      const inTier = st.players.filter(p => Number(p.totalInvested||0) >= L);
      const tierAmount = (L - prev) * inTier.length;
      prev = L;
      if(tierAmount <= 0) continue;

      const eligible = inTier.filter(p => p.inHand && !p.folded);
      if(eligible.length === 0) continue;

      let bestTier = eligible[0]._eval;
      for(const p of eligible){
        if(cmpEval(p._eval, bestTier) > 0) bestTier = p._eval;
      }
      const winners = eligible.filter(p => cmpEval(p._eval, bestTier) === 0);

      const share = Math.floor(tierAmount / winners.length);
      let rem = tierAmount - share * winners.length;

      const ordered = winners.slice().sort((a,b)=>a.id-b.id);
      for(const w of ordered){
        w.stack += share;
        won.set(w.id, (won.get(w.id)||0) + share);
      }
      for(let i=0; i<ordered.length && rem>0; i++){
        ordered[i].stack += 1;
        won.set(ordered[i].id, (won.get(ordered[i].id)||0) + 1);
        rem--;
      }
      hist(st, `Side pot (${tierAmount}) nyertes(ek): ${ordered.map(w=>w.name).join(", ")} ‚Äì ${bestTier.name}`);
    }

    st.handActive=false;
    const summary = st.players
      .filter(p => (won.get(p.id)||0) > 0)
      .map(p => `${p.name} +${won.get(p.id)}`)
      .join(" | ");
    if(summary) hist(st, `Kifizet√©sek: ${summary}`);
  }

  // ---------------------------
  // Bots (host)
  // ---------------------------
  let botTimer = null;
  function scheduleBotIfNeeded(){
    if(!isHost() || !hostState) return;
    if(!hostState.handActive) return;
    if(hostState.toAct == null) return;
    const p = hostState.players?.[hostState.toAct];
    if(!p || !p.isBot) return;
    if(botTimer) return;

    botTimer = setTimeout(() => {
      botTimer = null;
      if(!hostState || !hostState.handActive) return;
      const idx = hostState.toAct;
      const bp = hostState.players?.[idx];
      if(!bp || !bp.isBot) return;

      const call = amountToCall(hostState, bp);
      const pressure = call / Math.max(1, bp.stack + call);
      const r=Math.random();

      if(call>0 && pressure>0.45 && r<0.55) actFold(hostState, idx);
      else if(r<0.12 && bp.stack > call + hostState.cfg.bb) actRaiseBy(hostState, idx, hostState.cfg.bb);
      else actCallCheck(hostState, idx);

      let guard=0;
      while(hostState.handActive && hostState.street!=="SHOWDOWN" && bettingClosed(hostState) && guard++<50){
        advanceStreet(hostState);
      }

      send({ type:"state", state: hostState });
      scheduleBotIfNeeded();
    }, 1500);
  }

  // ---------------------------
  // Game setup
  // ---------------------------
  function getCfgForNewGame(){
    const cfg = (isHost())
      ? {
          bots: Number(ui.botCount.value||0),
          stack: Number(ui.stackSel.value||1000),
          blinds: ui.blindsSel.value
        }
      : lobby.cfg;

    const bots = Number(cfg.bots||0);
    const stack = Number(cfg.stack||1000);
    const [sb,bb] = String(cfg.blinds||"10,20").split(",").map(n=>Number(n));
    return { bots, stack, sb, bb };
  }

  function buildInitialState(){
    const humans = lobby.humans.slice();
    const { bots, stack, sb, bb } = getCfgForNewGame();

    const players = [
      ...humans.map((h,idx)=>({ id: idx, name: h.name, isBot:false, stack, hand:[], inHand:true, folded:false, allIn:false, bet:0, totalInvested:0, _eval:null })),
      ...Array.from({length:bots}).map((_,i)=>({ id: humans.length+i, name:`Robot #${i+1}`, isBot:true, stack, hand:[], inHand:true, folded:false, allIn:false, bet:0, totalInvested:0, _eval:null }))
    ];

    return {
      cfg:{ sb, bb, stack, bots },
      history: [],
      handNo:0,
      dealer:0,
      sbIndex:null,
      bbIndex:null,
      deck:[],
      community:[],
      pot:0,
      street:"PREFLOP",
      toAct:null,
      currentBet:0,
      acted:[],
      handActive:false,
      msg:"J√°t√©k indul!",
      showdownInfo:null,
      showAllHands:false,
      players
    };
  }

  function startGameAsHost(){
    if(!everyoneReady()) return alert("Nem minden ember K√âSZ m√©g.");
    lobby.started = true;
    hostState = buildInitialState();
    startHand(hostState);
    send({ type:"start", state: hostState });
    send({ type:"state", state: hostState });
    scheduleBotIfNeeded();
  }
  function newHandAsHost(){
    if(!hostState || !lobby.started) return alert("M√©g nincs elind√≠tva a j√°t√©k.");
    if(hostState.handActive) return alert("A leoszt√°s m√©g tart.");
    startHand(hostState);
    send({ type:"state", state: hostState });
    scheduleBotIfNeeded();
  }
  function newGameAsHost(){
    if(!everyoneReady()) return alert("√öj j√°t√©khoz minden ember legyen K√âSZ.");
    lobby.started = true;
    hostState = buildInitialState();
    startHand(hostState);
    send({ type:"start", state: hostState });
    send({ type:"state", state: hostState });
    scheduleBotIfNeeded();
  }

  function handleIntentAsHost(msg){
    if(msg.intent === "chat"){
      // host tov√°bbk√ºldi chat-et mindenkinek (felt√©telezve, hogy a szerver ezt is kezeli),
      // de ha a szerver eleve broadcastolja, akkor ez nem kell.
      // Itt nem piszk√°ljuk.
      return;
    }

    // action only
    if(!hostState || !hostState.handActive) return;
    if(msg.intent !== "action") return;

    const seat = msg.seat;
    if(seat==null) return;
    if(hostState.toAct !== seat) return;

    const p = hostState.players[seat];
    if(!p || p.isBot) return;

    if(msg.action==="fold") actFold(hostState, seat);
    if(msg.action==="call") actCallCheck(hostState, seat);
    if(msg.action==="raise") actRaiseBy(hostState, seat, Number(msg.amount||0));

    let guard=0;
    while(hostState.handActive && hostState.street!=="SHOWDOWN" && bettingClosed(hostState) && guard++<50){
      advanceStreet(hostState);
    }

    send({ type:"state", state: hostState });
    scheduleBotIfNeeded();
  }

  // ---------------------------
  // UI events (actions)
  // ---------------------------
  ui.actionFold.onclick = ()=> send({ type:"intent", intent:"action", action:"fold", amount:0 });
  ui.actionCall.onclick = ()=> send({ type:"intent", intent:"action", action:"call", amount:0 });
  ui.actionRaise.onclick = ()=> send({ type:"intent", intent:"action", action:"raise", amount:Number(ui.raiseAmt.value||0) });

  ui.startGameBtn.onclick = ()=> { if(!isHost()) return; if(lobby.started) return alert("A j√°t√©k m√°r elindult."); startGameAsHost(); };
  ui.newHandBtn.onclick  = ()=> { if(!isHost()) return; newHandAsHost(); };
  ui.newGameBtn.onclick  = ()=> { if(!isHost()) return; newGameAsHost(); };

  ui.topupBtn.onclick = () => {
    if(!isHost() || !hostState) return;
    if(hostState.handActive){ alert("Zsetont csak k√∂r v√©g√©n adj!"); return; }

    const seatIdx = Number(ui.topupPlayer.value);
    const amt = Math.max(1, Number(ui.topupAmt.value || 0));

    const p = hostState.players?.[seatIdx];
    if(!p || p.isBot){ alert("Csak ember j√°t√©kosnak adhatsz zsetont."); return; }

    p.stack += amt;
    if(p.stack > 0) p.allIn = false;

    hostState.history = hostState.history || [];
    hostState.history.push(`HOST: ${p.name} kapott +${amt} zsetont.`);
    hostState.msg = `HOST zsetont adott: ${p.name} +${amt}`;

    send({ type:"state", state: hostState });
  };

  // ---------------------------
  // Seat positioning
  // ---------------------------
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function getSeatPos(i, n){
    const me = (mySeat == null ? 0 : mySeat);
    const rel = (i - me + n) % n;
    const angleStart = Math.PI / 2;
    const step = (2*Math.PI) / Math.max(2, n);
    const a = angleStart + rel * step;

    const rect = ui.tableEl.getBoundingClientRect();
    const rx = rect.width * 0.41;
    const ry = rect.height * 0.37;

    const cx = 50, cy = 50;
    let x = cx + (Math.cos(a) * (rx / rect.width) * 100);
    let y = cy + (Math.sin(a) * (ry / rect.height) * 100);

    x = clamp(x, 10, 90);
    y = clamp(y, 12, 88);
    return {x, y};
  }

  // ---------------------------
  // Render
  // ---------------------------
  function renderTable(st){
    ui.boardRow.innerHTML="";
    for(const c of (st.community||[])) ui.boardRow.appendChild(renderCard(c));

    ui.myHandRow.innerHTML = "";
    if(mySeat!=null && st.players?.[mySeat]?.hand?.length===2){
      ui.myHandRow.appendChild(renderCard(st.players[mySeat].hand[0]));
      ui.myHandRow.appendChild(renderCard(st.players[mySeat].hand[1]));
    } else {
      ui.myHandRow.appendChild(faceDown());
      ui.myHandRow.appendChild(faceDown());
    }

    // ‚úÖ FIX: csak showdownban mutatjuk (vagy ha st.showAllHands true)
    const showAllHands = !!st.showAllHands && (st.street === "SHOWDOWN");

    ui.seatLayer.innerHTML="";
    const players = st.players || [];
    const n = players.length;

    for(let i=0;i<n;i++){
      const p = players[i];
      const pos = getSeatPos(i, n);

      const el = document.createElement("div");
      el.className = "seat";
      el.style.left = pos.x + "%";
      el.style.top  = pos.y + "%";

      if(st.handActive && st.toAct===i) el.classList.add("toActBlink");
      if(p.folded) el.classList.add("folded");
      if(mySeat===i) el.classList.add("me");

      const badges = [];
      if(i===st.dealer) badges.push(`<span class="pill d">D</span>`);
      if(i===st.sbIndex) badges.push(`<span class="pill sb">SB</span>`);
      if(i===st.bbIndex) badges.push(`<span class="pill bb">BB</span>`);

      el.innerHTML = `
        <div class="topline">
          <div class="name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}${p.isBot?" ü§ñ":""}</div>
          <div class="meta">üí∞ ${p.stack}</div>
        </div>
        <div class="badges">${badges.join(" ")}</div>
        <div class="small" style="font-size:14px;font-weight:900;color:#ffcf5a">
          üí∞ T√©t: ${p.bet} ${p.folded ? "‚Ä¢ DOBOTT" : (p.allIn ? "‚Ä¢ ALL-IN" : "")}
        </div>
      `;

      if(showAllHands && !p.folded && p.hand?.length===2){
        const handRow = document.createElement("div");
        handRow.className = "handMini";
        handRow.appendChild(renderCard(p.hand[0]));
        handRow.appendChild(renderCard(p.hand[1]));
        el.appendChild(handRow);

        if(p._eval){
          const ev = document.createElement("div");
          ev.className = "small";
          ev.textContent = `Komb√≥: ${p._eval.name}`;
          el.appendChild(ev);
        }
      }
      ui.seatLayer.appendChild(el);
    }
  }

  function render(){
    ui.host.textContent = hostId || "‚Äî";
    ui.seat.textContent = (mySeat==null ? "‚Äî" : String(mySeat));
    ui.startInfo.textContent = lobby.started ? "J√°t√©k fut" : "V√°rakoz√°s (K√©sz / Ready)‚Ä¶";

    ui.tabHost.classList.toggle("hidden", !isHost());

    const isReady = lobby.ready[clientId] === true;
    ui.readyBtn.textContent = isReady ? "K√âSZ ‚úî" : "K√âSZ / READY";
    ui.readyBtn.classList.toggle("readyOn", isReady);

    // players list
    ui.players.innerHTML = "";
    for(const h of (lobby.humans||[])){
      const row=document.createElement("div");
      row.className="pitem";

      const left=document.createElement("div");
      left.textContent = h.name;

      const money=document.createElement("div");
      money.style.fontSize="12px";
      money.style.color="#bfe6d9";
      const stack = state?.players?.[h.seat]?.stack;
      money.textContent = `üí∞ ${stack ?? "‚Äî"}`;

      const right=document.createElement("span");
      const ok = lobby.ready[h.clientId] === true;
      right.className = "pill " + (ok ? "ready" : "notready");
      right.textContent = ok ? "K√âSZ" : "NEM K√âSZ";

      row.appendChild(left);
      row.appendChild(money);
      row.appendChild(right);
      ui.players.appendChild(row);
    }

    // host topup select
    if(isHost() && ui.topupPlayer){
      ui.topupPlayer.innerHTML = "";
      const src = hostState || state;
      for(let i=0;i<(lobby.humans?.length||0);i++){
        const nm = lobby.humans[i]?.name || `J√°t√©kos ${i}`;
        const stck = src?.players?.[i]?.stack;
        const opt = document.createElement("option");
        opt.value = String(i);
        opt.textContent = (stck==null) ? nm : `${nm} (${stck})`;
        ui.topupPlayer.appendChild(opt);
      }
    }
    ui.topupBtn.disabled = !isHost() || !hostState || (hostState && hostState.handActive);

    if(!lobby.started || !state){
      ui.streetLbl.textContent = "‚Äî";
      ui.currentBetLbl.textContent = "0";
      ui.potLbl.textContent = "0";
      ui.handNoLbl.textContent = "0";
      ui.actionFold.disabled = true;
      ui.actionCall.disabled = true;
      ui.actionRaise.disabled = true;
      ui.yourTurnBox.classList.add("hidden");
      ui.turnHint.textContent = "V√°rakoz√°s a host ind√≠t√°s√°ra‚Ä¶";
      ui.winnerBanner.classList.add("hidden");
      ui.boardRow.innerHTML="";
      ui.myHandRow.innerHTML="";
      ui.seatLayer.innerHTML="";
      return;
    }

    ui.streetLbl.textContent = ({PREFLOP:"Preflop",FLOP:"Flop",TURN:"Turn",RIVER:"River",SHOWDOWN:"Showdown"}[state.street]||state.street);
    ui.currentBetLbl.textContent = String(state.currentBet || 0);
    ui.potLbl.textContent = String(state.pot || 0);
    ui.handNoLbl.textContent = String(state.handNo || 0);

    renderTable(state);

    const canAct = state.handActive && state.toAct===mySeat;

    ui.actionFold.disabled = !canAct;
    ui.actionCall.disabled = !canAct;
    ui.actionRaise.disabled = !canAct;
    ui.yourTurnBox.classList.toggle("hidden", !canAct);

    // PASS <-> MEGAD: X
    if (canAct) {
      const meP = state.players[mySeat];
      const need = amountToCall(state, meP);
      ui.actionCall.textContent = (need > 0) ? `MEGAD: ${need}` : "PASS";
    } else {
      ui.actionCall.textContent = "PASS";
    }

    // showdown banner
    if ((state.street === "SHOWDOWN" || !state.handActive) && state.showdownInfo?.winners?.length){
      const w = state.showdownInfo.winners.join(", ");
      ui.winnerBanner.textContent = `üèÜ Nyertes: ${w} ‚Äî ${state.showdownInfo.handName}`;
      ui.winnerBanner.classList.remove("hidden");
    } else {
      ui.winnerBanner.classList.add("hidden");
    }

    if(!state.handActive){
      ui.turnHint.textContent = "Leoszt√°s v√©ge. Host: √öJ K√ñR / √öJ J√ÅT√âK (Host f√ºl√∂n).";
    } else {
      const actor = state.players[state.toAct];
      const callAmt = amountToCall(state, actor);
      if(state.toAct === mySeat){
        ui.turnHint.textContent = callAmt===0
          ? `Te vagy soron: PASS / EMEL√âS / DOB√ÅS.`
          : `Te vagy soron: MEGAD√ÅS ${callAmt} / EMEL√âS / DOB√ÅS.`;
      } else {
        ui.turnHint.textContent = `${actor.name} k√∂vetkezik‚Ä¶ ${actor.isBot ? "(robot gondolkodik‚Ä¶)" : ""}`;
      }
    }
  }

  // ---------------------------
  // Connect
  // ---------------------------
  function connect(){
    ui.status.textContent = "csatlakoz√°s‚Ä¶";
    ws = new WebSocket(wsUrl);

    ws.addEventListener("open", ()=>{
      ui.status.textContent = "online";
      send({ type:"join", room, name, pw });
    });

    ws.addEventListener("close", ()=> ui.status.textContent = "offline");
    ws.addEventListener("error", ()=> ui.status.textContent = "hiba");

    ws.addEventListener("message", (ev)=>{
      let msg;
      try{ msg = JSON.parse(ev.data); } catch { return; }

      if(msg.type==="welcome"){
        clientId = msg.clientId;
        hostId = msg.hostId;
        mySeat = Number(msg.seat);
        send({ type:"getLobby" });
        render();
        return;
      }

      if(msg.type==="hostChanged"){ hostId = msg.hostId; render(); return; }
      if(msg.type==="lobby"){ lobby = msg.lobby; hostId = msg.hostId; render(); return; }

      if(msg.type==="start"){
        lobby.started = true;
        state = msg.state;
        if(isHost()) hostState = JSON.parse(JSON.stringify(state));
        render();
        scheduleBotIfNeeded();
        return;
      }

      if(msg.type==="state"){
        state = msg.state;
        if(isHost()) hostState = JSON.parse(JSON.stringify(state));
        render();
        scheduleBotIfNeeded();
        return;
      }

      if(msg.type==="chat"){ appendChat(msg.name, msg.text); return; }

      if(msg.type==="intent" && isHost()){ handleIntentAsHost(msg); return; }

      if(msg.type==="error"){ alert(msg.message || "Hiba"); }
    });

    // ‚úÖ FIX: renderelj√ºnk stabilan resize eset√©n is
    window.addEventListener("resize", ()=> { if(state) render(); });
  }

  connect();
</script>
</body>
</html>
