<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Texas Hold'em ‚Äì Online</title>
  <style>
    :root{
      --bg:#0b3d2e;--text:#eaf7f2;--muted:#bfe6d9;--acc:#ffcf5a;
      --line:rgba(255,255,255,.14);--danger:#ff4d4d;--ok:#6bffb1;
    }

    /* ‚úÖ Chrome PC ‚Äúchat elcs√∫sz√°s‚Äù ellen: dokumentum fix */
    html, body{
      height:100%;
      margin:0;
      overflow:hidden;
      overscroll-behavior:none;
    }
    body{
      position:fixed;
      inset:0;
      display:flex;
      flex-direction:column;
      font-family:system-ui,Arial;
      background:radial-gradient(1200px 800px at 50% 15%, #14624a, var(--bg));
      color:var(--text);
    }

    header{
      padding:10px 12px;display:flex;gap:10px;justify-content:space-between;align-items:center;
      background:rgba(0,0,0,.18);border-bottom:1px solid var(--line);flex-wrap:wrap;
      flex:0 0 auto;
    }

    .badge{font-size:12px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06);color:var(--muted)}
    .badge.bigMoney{font-size:16px;font-weight:900;color:var(--acc)}
    .big{font-size:16px;font-weight:900;color:var(--acc)}

    select,button,input{border:1px solid var(--line);background:rgba(0,0,0,.18);color:var(--text);padding:10px;border-radius:12px;outline:none;box-sizing:border-box}
    button{cursor:pointer;font-weight:900}
    button:disabled{opacity:.5;cursor:not-allowed}
    button.readyOn{background:rgba(31,122,74,.45);border-color:rgba(107,255,177,.55);color:#eafff4}

    .app{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      padding:10px;
      gap:10px;
    }

    .topbar{
      display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      flex:0 0 auto;
    }
    .tabs{display:flex;gap:8px}
    .tab{min-width:120px;display:flex;align-items:center;justify-content:center;gap:8px}
    .tab.active{border-color:rgba(255,207,90,.6);box-shadow:0 0 0 6px rgba(255,207,90,.08)}
    .hidden{display:none}

    .panel{
      border:1px solid var(--line);border-radius:16px;background:rgba(0,0,0,.16);
      padding:12px; position:relative;
      min-height:0;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

    .gameView{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .tableWrap{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:10px;
      align-items:stretch;
      justify-content:center;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:rgba(255,255,255,.06);
      padding:10px;
      overflow:hidden;
    }

    .table{
      position:relative;
      width:100%;
      height:100%;
      border-radius:999px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(0,0,0,.25), transparent 45%),
        repeating-linear-gradient(45deg, rgba(255,255,255,.03), rgba(255,255,255,.03) 6px, transparent 6px, transparent 12px),
        radial-gradient(ellipse at center, #0f5a3f, #083b2a);
      box-shadow: inset 0 0 60px rgba(0,0,0,.55), 0 20px 60px rgba(0,0,0,.45);
    }
    .table::before{content:"";position:absolute; inset:18px;border-radius:999px;border:1px dashed rgba(255,255,255,.14)}

    .boardCenter{
      position:absolute;left:50%; top:50%;transform:translate(-50%,-50%);
      width:min(740px, 94%);
      padding:10px 8px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);text-align:center
    }
    .boardRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;align-items:center;min-height:72px}
    .myHandRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:10px}

    .card{width:46px;height:64px;background:#f7f7f7;color:#1b1b1b;border-radius:10px;display:flex;flex-direction:column;justify-content:space-between;padding:6px;border:1px solid rgba(0,0,0,.12)}
    .seat{
      position:absolute;width:160px;padding:8px 10px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);
      transform:translate(-50%,-50%);font-size:11px;line-height:1.2;
    }
    .seat .topline{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .seat .name{font-weight:900;color:var(--text);max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .seat .meta{color:var(--muted);white-space:nowrap}
    .seat.folded{opacity:.55}
    .seat.me{border-color:rgba(107,255,177,.35)}
    .seat.toAct{outline:4px solid rgba(255,77,77,1); box-shadow:0 0 18px rgba(255,77,77,.6);}

    .actionPanel{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:12px;
      border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      backdrop-filter: blur(6px);
      min-width:0;
    }
    .actionPanel button, .actionPanel input{width:100%}
    .turnBox{
      padding:8px 10px;border-radius:14px;border:1px solid rgba(255,77,77,.35);
      background:rgba(255,77,77,.08);display:flex;align-items:center;font-weight:900;color:#ffd5d5;
    }
    .turnBox.hidden{display:none}
    .turnDot{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--danger);box-shadow:0 0 10px rgba(255,77,77,.6);margin-right:8px;}

    /* CHAT */
    #viewChat{ overflow:hidden; min-height:0; }
    .chatGrid{
      flex:1;
      min-height:0;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:10px;
    }
    .chatGrid > *{ min-height:0; }

    .scrollBox{min-height:0;overflow:auto;border:1px solid var(--line);border-radius:14px;padding:10px;background:rgba(255,255,255,.06)}
    .playersList .pitem{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,.12);align-items:center}
    .playersList .pitem:last-child{border-bottom:none}

    .chatbox{
      flex:1;
      min-height:0;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,.18);
      white-space:pre-wrap
    }
    .chatline{margin:0 0 8px 0;color:var(--muted)}
    .chatline b{color:var(--acc)}
    .mention{color:var(--acc);font-weight:900}
    .chatSend{display:flex;gap:8px;margin-top:10px}
    .chatSend input{flex:1}
    #chatNotif{background:#ff4d4d;color:white;font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid rgba(0,0,0,.18)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35;margin-top:8px}

    @media (max-width: 980px){
      /* mobilon legyen scroll */
      html, body{overflow:auto}
      body{position:static}
      .chatGrid{grid-template-columns:1fr}
      .tableWrap{grid-template-columns:1fr; height:520px}
    }
  </style>
</head>
<body>
<header>
  <div class="row" style="gap:10px">
    <span class="badge">Szoba: <b id="room"></b></span>
    <span class="badge">Te: <b id="me"></b></span>
    <span class="badge">Kapcsolat: <b id="status">‚Äî</b></span>
    <span class="badge">Sz√©k: <b id="seat">‚Äî</b></span>
    <span class="badge">Host: <b id="host">‚Äî</b></span>
  </div>
  <div class="big" id="startInfo">V√°rakoz√°s (K√©sz / Ready)‚Ä¶</div>
</header>

<div class="app">
  <div class="topbar">
    <div class="row" style="gap:10px">
      <button id="readyBtn">K√âSZ / READY</button>
      <span class="badge">Utca: <b id="streetLbl">‚Äî</b></span>
      <span class="badge bigMoney">Aktu√°lis t√©t: <b id="currentBetLbl">0</b></span>
      <span class="badge bigMoney">üí∞ Pot: <b id="potLbl">0</b></span>
      <span class="badge">K√∂r: <b id="handNoLbl">0</b></span>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabGame">J√°t√©k</button>
      <button class="tab" id="tabChat">Chat <span id="chatNotif" class="badge hidden">‚óè</span></button>
      <button class="tab hidden" id="tabHost">Host</button>
    </div>
  </div>

  <!-- GAME -->
  <section class="panel gameView" id="viewGame">
    <div class="tableWrap">
      <div class="table" id="table">
        <div class="boardCenter">
          <div class="badge" style="display:inline-block;margin-bottom:8px">K√∂z√∂s lapok (demo)</div>
          <div class="boardRow" id="boardRow"></div>

          <div class="badge" style="display:inline-block;margin:10px 0 6px 0">Saj√°t lapjaid (demo)</div>
          <div class="myHandRow" id="myHandRow"></div>

          <div class="hint" id="turnHint" style="margin-top:8px;font-size:13px">‚Äî</div>
        </div>
        <div id="seatLayer"></div>
      </div>

      <div class="actionPanel">
        <div id="yourTurnBox" class="turnBox hidden"><span class="turnDot"></span>TE VAGY SORON!</div>
        <button id="actionCall">PASS / CALL</button>
        <button id="actionFold">DOB√ÅS</button>
        <input id="raiseAmt" type="number" value="40" min="0" step="10" />
        <button id="actionRaise">EMEL√âS (raise to)</button>
        <div class="hint">Emel√©s mez≈ë: <b>c√©l t√©t szint</b> (pl. 80-ig emel).</div>
      </div>
    </div>
  </section>

  <!-- CHAT -->
  <section class="panel hidden" id="viewChat" style="flex:1;min-height:0;">
    <div class="chatGrid">
      <div class="scrollBox playersList">
        <div class="badge">J√°t√©kosok</div>
        <div class="hint">N√©v ‚Ä¢ üí∞ stack ‚Ä¢ K√âSZ</div>
        <div id="players" style="margin-top:10px"></div>
      </div>

      <div style="min-height:0;display:flex;flex-direction:column;gap:10px">
        <div class="badge">Chat</div>
        <div class="chatbox" id="chatBox"></div>
        <div class="chatSend">
          <input id="chatMsg" placeholder="√çrj valamit‚Ä¶ (@Bruno)" maxlength="300" />
          <button id="chatSend">K√ºld√©s</button>
        </div>
        <div class="hint">Taggel√©s: pl. <b>@Bruno</b></div>
      </div>
    </div>
  </section>

  <!-- HOST -->
  <section class="panel hidden" id="viewHost" style="flex:1;min-height:0;">
    <div>
      <div class="badge">Host</div>
      <div class="hint">Demo m√≥d: csak start + k√∂rben akci√≥k.</div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="startGameBtn">‚ñ∂ J√ÅT√âK IND√çT√ÅSA</button>
      </div>
    </div>
  </section>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const room = (qs.get("room")||"").trim();
  const name = (qs.get("name")||"").trim();
  const wsUrl = (qs.get("ws")||"").trim();
  const pw = sessionStorage.getItem("poker_room_pw") || "";

  if(!room || !name || !wsUrl || !pw){
    alert("Hi√°nyzik a szoba / n√©v / ws / jelsz√≥. Menj vissza a lobbyba!");
    location.href = "pokerlobby.html";
  }

  const ui = {
    room: document.getElementById("room"),
    me: document.getElementById("me"),
    status: document.getElementById("status"),
    seat: document.getElementById("seat"),
    host: document.getElementById("host"),
    startInfo: document.getElementById("startInfo"),

    streetLbl: document.getElementById("streetLbl"),
    currentBetLbl: document.getElementById("currentBetLbl"),
    potLbl: document.getElementById("potLbl"),
    handNoLbl: document.getElementById("handNoLbl"),

    tabGame: document.getElementById("tabGame"),
    tabChat: document.getElementById("tabChat"),
    tabHost: document.getElementById("tabHost"),
    chatNotif: document.getElementById("chatNotif"),

    viewGame: document.getElementById("viewGame"),
    viewChat: document.getElementById("viewChat"),
    viewHost: document.getElementById("viewHost"),

    readyBtn: document.getElementById("readyBtn"),

    boardRow: document.getElementById("boardRow"),
    myHandRow: document.getElementById("myHandRow"),
    seatLayer: document.getElementById("seatLayer"),
    tableEl: document.getElementById("table"),
    turnHint: document.getElementById("turnHint"),

    actionFold: document.getElementById("actionFold"),
    actionCall: document.getElementById("actionCall"),
    actionRaise: document.getElementById("actionRaise"),
    raiseAmt: document.getElementById("raiseAmt"),
    yourTurnBox: document.getElementById("yourTurnBox"),

    players: document.getElementById("players"),
    chatBox: document.getElementById("chatBox"),
    chatMsg: document.getElementById("chatMsg"),
    chatSend: document.getElementById("chatSend"),

    startGameBtn: document.getElementById("startGameBtn"),
  };

  ui.room.textContent = room;
  ui.me.textContent = name;

  function switchTab(which){
    ui.tabGame.classList.toggle("active", which==="game");
    ui.tabChat.classList.toggle("active", which==="chat");
    ui.tabHost.classList.toggle("active", which==="host");

    ui.viewGame.classList.toggle("hidden", which!=="game");
    ui.viewChat.classList.toggle("hidden", which!=="chat");
    ui.viewHost.classList.toggle("hidden", which!=="host");

    if(which==="chat") ui.chatNotif.classList.add("hidden");
  }
  ui.tabGame.onclick = ()=>switchTab("game");
  ui.tabChat.onclick = ()=>switchTab("chat");
  ui.tabHost.onclick = ()=>switchTab("host");
  switchTab("game");

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function highlightMentionsSafe(text){
    const safe = escapeHtml(text);
    return safe.replace(/@([^\s]+)/g, (m,p1)=>`<span class="mention">@${p1}</span>`);
  }

  function appendChat(n,t){
    const p=document.createElement("p");
    p.className="chatline";
    p.innerHTML = `<b>${escapeHtml(n)}:</b> ${highlightMentionsSafe(t)}`;
    ui.chatBox.appendChild(p);
    ui.chatBox.scrollTop = ui.chatBox.scrollHeight;
    if(ui.viewChat.classList.contains("hidden")) ui.chatNotif.classList.remove("hidden");
  }

  function faceDown(){
    const d=document.createElement("div");
    d.className="card";
    d.style.background="rgba(0,0,0,.18)";
    d.style.color="rgba(255,255,255,.65)";
    d.innerHTML="<div style='font-weight:900'>?</div><div style='align-self:flex-end'>üÇ†</div>";
    return d;
  }

  // ===== WS + state
  let ws=null, clientId=null, hostId=null, mySeat=null;
  let lobby = { humans:[], ready:{}, hostId:null, started:false };
  let state = null;

  function isHost(){ return clientId && hostId && clientId===hostId; }
  function send(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }

  ui.chatSend.onclick = ()=>{
    const text = ui.chatMsg.value.trim().slice(0,300);
    if(!text) return;
    ui.chatMsg.value="";
    send({ type:"intent", intent:"chat", text });
  };
  ui.chatMsg.addEventListener("keydown",(e)=>{
    if(e.key==="Enter"){
      e.preventDefault();
      ui.chatSend.click();
    }
  });

  ui.readyBtn.onclick = ()=>{
    const cur = !!lobby.ready?.[clientId];
    send({ type:"intent", intent: cur ? "unready" : "ready" });
  };

  ui.startGameBtn.onclick = ()=>{
    if(!isHost()) return;
    send({ type:"intent", intent:"startGame" });
  };

  ui.actionFold.onclick = ()=> send({ type:"intent", intent:"action", action:"fold" });
  ui.actionCall.onclick = ()=> send({ type:"intent", intent:"action", action:"call" });
  ui.actionRaise.onclick = ()=> send({ type:"intent", intent:"action", action:"raise", amount:Number(ui.raiseAmt.value||0) });

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
  function getSeatPos(i, n){
    const me = (mySeat == null ? 0 : mySeat);
    const rel = (i - me + n) % n;
    const angleStart = Math.PI / 2;
    const step = (2*Math.PI) / Math.max(2, n);
    const a = angleStart + rel * step;

    const rect = ui.tableEl.getBoundingClientRect();
    const rx = rect.width * 0.41;
    const ry = rect.height * 0.37;

    const cx = 50, cy = 50;
    let x = cx + (Math.cos(a) * (rx / rect.width) * 100);
    let y = cy + (Math.sin(a) * (ry / rect.height) * 100);

    x = clamp(x, 10, 90);
    y = clamp(y, 12, 88);
    return {x, y};
  }

  function myIndexFromState(){
    if(!state?.players?.length || !clientId) return null;
    const idx = state.players.findIndex(p => p.id === clientId);
    return idx >= 0 ? idx : null;
  }

  function renderTable(){
    ui.boardRow.innerHTML = "";
    ui.myHandRow.innerHTML = "";
    // demo lapok
    ui.boardRow.appendChild(faceDown());
    ui.boardRow.appendChild(faceDown());
    ui.boardRow.appendChild(faceDown());
    ui.myHandRow.appendChild(faceDown());
    ui.myHandRow.appendChild(faceDown());

    ui.seatLayer.innerHTML = "";
    const players = state?.players || [];
    const n = players.length;

    const myIdx = myIndexFromState();

    for(let i=0;i<n;i++){
      const p = players[i];
      const pos = getSeatPos(i, n);

      const el = document.createElement("div");
      el.className = "seat";
      el.style.left = pos.x + "%";
      el.style.top  = pos.y + "%";

      if(state?.handActive && state.toAct===i) el.classList.add("toAct");
      if(p.folded) el.classList.add("folded");
      if(myIdx === i) el.classList.add("me");
      if(state?.toAct === i && state?.handActive) el.classList.add("toAct");

      el.innerHTML = `
        <div class="topline">
          <div class="name" title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</div>
          <div class="meta">üí∞ ${p.stack}</div>
        </div>
        <div style="margin-top:6px;font-size:14px;font-weight:900;color:#ffcf5a">
          üí∞ T√©t: ${p.bet} ${p.folded ? "‚Ä¢ DOBOTT" : (p.allIn ? "‚Ä¢ ALL-IN" : "")}
        </div>
      `;

      ui.seatLayer.appendChild(el);
    }
  }

  function render(){
    ui.host.textContent = hostId || "‚Äî";
    ui.seat.textContent = (mySeat==null ? "‚Äî" : String(mySeat));
    ui.tabHost.classList.toggle("hidden", !isHost());

    const isReady = lobby.ready?.[clientId] === true;
    ui.readyBtn.textContent = isReady ? "K√âSZ ‚úî" : "K√âSZ / READY";
    ui.readyBtn.classList.toggle("readyOn", isReady);

    ui.startInfo.textContent = lobby.started ? "J√°t√©k fut" : "V√°rakoz√°s (K√©sz / Ready)‚Ä¶";

    // chat tab j√°t√©koslista
    ui.players.innerHTML = "";
    const humans = lobby.humans || [];
    for(const h of humans.slice().sort((a,b)=>a.seat-b.seat)){
      const row=document.createElement("div");
      row.className="pitem";

      const left=document.createElement("div");
      left.textContent = h.name;

      const money=document.createElement("div");
      money.style.fontSize="12px";
      money.style.color="#bfe6d9";
      const st = state?.players?.find(p=>p.id===h.clientId)?.stack;
      money.textContent = `üí∞ ${st ?? "‚Äî"}`;

      const right=document.createElement("span");
      const ok = lobby.ready?.[h.clientId] === true;
      right.className = "badge";
      right.textContent = ok ? "K√âSZ" : "NEM K√âSZ";

      row.appendChild(left);
      row.appendChild(money);
      row.appendChild(right);
      ui.players.appendChild(row);
    }

    if(!state){
      ui.streetLbl.textContent = "‚Äî";
      ui.currentBetLbl.textContent = "0";
      ui.potLbl.textContent = "0";
      ui.handNoLbl.textContent = "0";

      ui.actionFold.disabled = true;
      ui.actionCall.disabled = true;
      ui.actionRaise.disabled = true;
      ui.yourTurnBox.classList.add("hidden");

      ui.turnHint.textContent = isHost()
        ? "Hostk√©nt ind√≠tsd a j√°t√©kot a Host f√ºl√∂n."
        : "V√°rakoz√°s a host ind√≠t√°s√°ra‚Ä¶";

      ui.seatLayer.innerHTML = "";
      ui.boardRow.innerHTML = "";
      ui.myHandRow.innerHTML = "";
      return;
    }

    ui.streetLbl.textContent = state.street || "‚Äî";
    ui.currentBetLbl.textContent = String(state.currentBet || 0);
    ui.potLbl.textContent = String(state.pot || 0);
    ui.handNoLbl.textContent = String(state.handNo || 0);

    renderTable();

    const myIdx = myIndexFromState();
    const canAct = (myIdx != null) && (state.toAct === myIdx);

    ui.actionFold.disabled = !canAct;
    ui.actionCall.disabled = !canAct;
    ui.actionRaise.disabled = !canAct;
    ui.yourTurnBox.classList.toggle("hidden", !canAct);

    ui.turnHint.textContent = canAct
      ? "Te vagy soron (demo): CALL / RAISE / FOLD"
      : "Valaki m√°s van soron‚Ä¶";
  }

  function connect(){
    ui.status.textContent = "csatlakoz√°s‚Ä¶";
    ws = new WebSocket(wsUrl);

    ws.addEventListener("open", ()=>{
      ui.status.textContent = "online";
      send({ type:"join", room, name, pw });
    });

    ws.addEventListener("close", ()=> ui.status.textContent = "offline");
    ws.addEventListener("error", ()=> ui.status.textContent = "hiba");

    ws.addEventListener("message", (ev)=>{
      let msg;
      try{ msg = JSON.parse(ev.data); } catch { return; }

      if(msg.type==="welcome"){
        clientId = msg.clientId;
        hostId = msg.hostId;
        mySeat = Number(msg.seat);
        send({ type:"getLobby" });
        render();
        return;
      }

      if(msg.type==="lobby"){
        lobby = msg.lobby || lobby;
        hostId = lobby.hostId || hostId;
        render();
        return;
      }

      if(msg.type==="state"){
        state = msg.state;
        render();
        return;
      }

      if(msg.type==="chat"){
        appendChat(msg.name, msg.text);
        return;
      }

      if(msg.type==="error"){
        alert(msg.message || "Hiba");
      }
    });

    window.addEventListener("resize", ()=> render());
  }

  connect();
</script>
</body>
</html>
